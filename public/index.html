<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anken</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>

    <script>
        // Firebase configuration - PLEASE REPLACE WITH YOUR OWN CONFIG
        window.__firebase_config = {
            apiKey: "AIzaSyD9qsQN6YvNbrtikGFARTs20-ABRSNSh9A",
            authDomain: "anken-0614.firebaseapp.com",
            projectId: "anken-0614",
            storageBucket: "anken-0614.appspot.com",
            messagingSenderId: "258080558206",
            appId: "1:258080558206:web:a9176c09cae666036b1c2f",
            measurementId: "G-633CQ2WNJX"
        };
        
        window.__app_id = typeof __app_id !== 'undefined' ? __app_id : window.__firebase_config.appId;
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            setPersistence,
            browserLocalPersistence,
            updatePassword,
            reauthenticateWithCredential,
            EmailAuthProvider,
            verifyBeforeUpdateEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, doc, updateDoc, deleteDoc, arrayUnion, getDocs, writeBatch, getDoc, runTransaction, setDoc, arrayRemove, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        window.firebase = {
            initializeApp, getApps, getApp, getAuth, onAuthStateChanged,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
            setPersistence, browserLocalPersistence,
            updatePassword, reauthenticateWithCredential, EmailAuthProvider,
            verifyBeforeUpdateEmail,
            getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp,
            doc, updateDoc, deleteDoc, arrayUnion, getDocs, writeBatch, getDoc, runTransaction, setDoc, arrayRemove, deleteField
        };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>


    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;
        
        const TimelineBar = ({ startDate, dueDate, status, events = [] }) => {
          if (!startDate || !dueDate) return <div className="text-gray-500 text-xs">日付未設定</div>;
          const start = new Date(startDate);
          const end = new Date(dueDate);
          const today = new Date();
          start.setHours(0, 0, 0, 0);
          end.setHours(0, 0, 0, 0);
          today.setHours(0, 0, 0, 0);
          const totalDurationMs = end.getTime() - start.getTime();
          const [activeTooltipIndex, setActiveTooltipIndex] = useState(null);
          const [showStartTooltip, setShowStartTooltip] = useState(false);
          const [showEndTooltip, setShowEndTooltip] = useState(false);
          const getEventTypeColor = (event) => { if (event.completed) return 'bg-green-500'; switch (event.type) { case '予定': case '提出': return 'bg-yellow-500'; case 'タスク': return 'bg-red-500'; case '完了': return 'bg-green-500'; default: return 'bg-purple-600'; } };
          const eventMarkers = (events || []).map((event) => { const eventDate = new Date(event.date); eventDate.setHours(0, 0, 0, 0); const eventOffsetMs = eventDate.getTime() - start.getTime(); let position = totalDurationMs > 0 ? (eventOffsetMs / totalDurationMs) * 100 : 0; return { ...event, position: Math.max(0, Math.min(100, position)) }; }).sort((a, b) => a.position - b.position);
          let progressPercentage = 0;
          if (totalDurationMs > 0) { const elapsedMs = today.getTime() - start.getTime(); progressPercentage = Math.max(0, Math.min(100, (elapsedMs / totalDurationMs) * 100)); }
          const barColorClass = 'bg-gray-700';
          const progressColorClass = status === '完了' ? 'bg-indigo-500' : 'bg-green-500';
          const todayMarkerPosition = totalDurationMs > 0 ? Math.max(0, Math.min(100, (today.getTime() - start.getTime()) / totalDurationMs * 100)) : -1;
          return (
            <div className="relative w-full h-8 rounded-lg my-1">
              <div className={`absolute top-1/2 -translate-y-1/2 left-0 h-0.5 ${barColorClass} w-full rounded-lg`}></div>
              {status !== '完了' && <div className={`absolute top-1/2 -translate-y-1/2 left-0 h-0.5 ${progressColorClass} transition-all duration-500 ease-out rounded-lg`} style={{ width: `${progressPercentage}%` }}></div>}
              {todayMarkerPosition >= 0 && <div className="absolute bottom-full mb-1 h-0 w-0 border-l-[6px] border-r-[6px] border-t-[8px] border-l-transparent border-r-transparent border-t-black z-10" style={{ left: `${todayMarkerPosition}%`, transform: 'translateX(-50%)' }} title="今日"></div>}
              <div className="absolute top-1/2 -translate-y-1/2 w-3 h-3 z-30 cursor-pointer" style={{ left: `0%`, transform: 'translateX(-50%)' }} onMouseEnter={() => setShowStartTooltip(true)} onMouseLeave={() => setShowStartTooltip(false)}>
                <div className="absolute left-1/2 -translate-x-1/2 w-0.5 h-4 bg-gray-800 -top-2"></div><div className="absolute left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-gray-800 -top-4"></div>
                {showStartTooltip && (<div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap"><p>開始日: {startDate}</p><div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div></div>)}
              </div>
              <div className="absolute top-1/2 -translate-y-1/2 w-3 h-3 z-30 cursor-pointer" style={{ left: `100%`, transform: 'translateX(-50%)' }} onMouseEnter={() => setShowEndTooltip(true)} onMouseLeave={() => setShowEndTooltip(false)}>
                <div className="absolute left-1/2 -translate-x-1/2 w-0.5 h-4 bg-gray-800 -top-2"></div><div className="absolute left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-gray-800 -top-4"></div>
                {showEndTooltip && (<div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap"><p>完了予定日: {dueDate}</p><div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div></div>)}
              </div>
              {eventMarkers.map((event, index) => (
                <div key={index} className={`absolute w-3 h-3 z-20 cursor-pointer ${getEventTypeColor(event)} ${event.type === 'タスク' ? '' : 'rounded-full'}`} style={{ left: `${event.position}%`, top: '50%', transform: 'translate(-50%, -50%)' }} onMouseEnter={() => setActiveTooltipIndex(index)} onMouseLeave={() => setActiveTooltipIndex(null)} onClick={() => setActiveTooltipIndex(activeTooltipIndex === index ? null : index)}>
                  {activeTooltipIndex === index && (<div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-40"><p>{event.date}</p><p>{event.description}</p>{event.pdfUrl && (<p className="text-xs text-gray-400"><a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-300 hover:underline">PDFを表示</a></p>)}<div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-4 border-t-gray-800"></div></div>)}
                </div>
              ))}
            </div>
          );
        };
        const VerticalCaseTimeline = ({ caseItem, displayStartDate, heightPerDay, openEditModal, onCaseHover }) => { /* No changes */ };
        const ListCalendarView = ({ cases, openEditModal }) => { /* No changes */ };
        const LoginPage = ({ auth, setAuthError, authError }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [isSignUp, setIsSignUp] = React.useState(false);
            const [loading, setLoading] = React.useState(false);
            const [showPassword, setShowPassword] = React.useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setAuthError(null);

                try {
                    if (isSignUp) {
                        await window.firebase.createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await window.firebase.signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    let errorMessage = "認証に失敗しました。";
                    if (error.code === 'auth/invalid-email') errorMessage = "メールアドレスの形式が正しくありません。";
                    if (error.code === 'auth/user-disabled') errorMessage = "このアカウントは無効化されています。";
                    if (error.code === 'auth/user-not-found') errorMessage = "このメールアドレスのアカウントは存在しません。";
                    if (error.code === 'auth/wrong-password') errorMessage = "パスワードが間違っています。";
                    if (error.code === 'auth/email-already-in-use') errorMessage = "このメールアドレスは既に使用されています。";
                    if (error.code === 'auth/weak-password') errorMessage = "パスワードが弱すぎます。6文字以上のパスワードを設定してください。";
                    setAuthError(errorMessage);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100">
                    <h1 className="text-3xl font-bold text-gray-800 mb-8 text-center">Ankenへようこそ</h1>
                    <div className="bg-white rounded-xl shadow-lg p-8 w-full max-w-md">
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">メールアドレス</label>
                                <input
                                    type="email"
                                    autoComplete="email"
                                    required
                                    value={email}
                                    onChange={e => setEmail(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">パスワード</label>
                                <div className="relative">
                                    <input
                                        type={showPassword ? "text" : "password"}
                                        autoComplete="current-password"
                                        required
                                        value={password}
                                        onChange={e => setPassword(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 pr-10"
                                    />
                                    <button
                                        type="button"
                                        tabIndex={-1}
                                        className="absolute inset-y-0 right-2 flex items-center text-gray-400"
                                        onClick={() => setShowPassword(!showPassword)}
                                        aria-label={showPassword ? "パスワードを隠す" : "パスワードを表示"}
                                    >
                                        {showPassword ? (
                                            // 目を閉じたアイコン
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59" />
                                            </svg>
                                        ) : (
                                            // 目のアイコン
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        )}
                                    </button>
                                </div>
                            </div>
                            {authError && (
                                <div className="text-red-600 text-sm">{authError}</div>
                            )}
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-md transition"
                            >
                                {loading ? '処理中...' : (isSignUp ? 'アカウント作成' : 'ログイン')}
                            </button>
                        </form>
                        <div className="flex items-center my-4">
                            <div className="flex-grow border-t border-gray-200"></div>
                            <span className="mx-2 text-gray-400 text-sm">アカウントをお持ちでないですか？</span>
                            <div className="flex-grow border-t border-gray-200"></div>
                        </div>
                        <button
                            onClick={() => setIsSignUp(!isSignUp)}
                            className="w-full border border-gray-300 py-2 rounded-md text-gray-700 hover:bg-gray-50 font-medium transition"
                        >
                            {isSignUp ? 'ログイン画面に戻る' : '新しくアカウントを作成'}
                        </button>
                    </div>
                </div>
            );
        };
        const SettingsModal = ({ user, auth, closeModal, showCustomAlert }) => {
            const [newEmail, setNewEmail] = React.useState(user.email);
            const [currentPassword, setCurrentPassword] = React.useState('');
            const [newPassword, setNewPassword] = React.useState('');
            const [confirmPassword, setConfirmPassword] = React.useState('');
            const [showNewPassword, setShowNewPassword] = React.useState(false);
            const [showConfirmPassword, setShowConfirmPassword] = React.useState(false);

            const handleUpdateEmail = async (e) => {
                e.preventDefault();
                if (newEmail === user.email) {
                    showCustomAlert("新しいメールアドレスが現在と同じです。");
                    return;
                }
                try {
                    await window.firebase.verifyBeforeUpdateEmail(auth.currentUser, newEmail);
                    showCustomAlert("確認メールを新しいメールアドレスに送信しました。メール内のリンクをクリックして変更を完了してください。");
                    closeModal();
                } catch (error) {
                    showCustomAlert(`メールアドレスの更新に失敗しました。時間をおいて再度お試しください。(${error.code})`);
                }
            };

            const handleUpdatePassword = async (e) => {
                e.preventDefault();
                if (newPassword !== confirmPassword) {
                    showCustomAlert("新しいパスワードが一致しません。");
                    return;
                }
                try {
                    const credential = window.firebase.EmailAuthProvider.credential(user.email, currentPassword);
                    await window.firebase.reauthenticateWithCredential(auth.currentUser, credential);
                    await window.firebase.updatePassword(auth.currentUser, newPassword);
                    showCustomAlert("パスワードを更新しました。");
                    closeModal();
                } catch (error) {
                    showCustomAlert(`パスワードの更新に失敗しました。(${error.code})`);
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full relative">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">アカウント設定</h2>
                        <button onClick={closeModal} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        <form onSubmit={handleUpdateEmail} className="space-y-4 mb-8">
                            <h3 className="text-lg font-semibold text-gray-700">メールアドレスの変更</h3>
                            <div>
                                <label htmlFor="new-email" className="block text-sm font-medium text-gray-700">新しいメールアドレス</label>
                                <input id="new-email" type="email" value={newEmail} onChange={(e) => setNewEmail(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">確認メールを送信</button>
                        </form>
                        <form onSubmit={handleUpdatePassword} className="space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700">パスワードの変更</h3>
                            <div>
                                <label htmlFor="current-password" className="block text-sm font-medium text-gray-700">現在のパスワード</label>
                                <input id="current-password" type="password" value={currentPassword} onChange={(e) => setCurrentPassword(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required />
                            </div>
                            <div className="relative">
                                <label htmlFor="new-password" className="block text-sm font-medium text-gray-700">新しいパスワード</label>
                                <input id="new-password" type={showNewPassword ? 'text' : 'password'} value={newPassword} onChange={(e) => setNewPassword(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm pr-10" required />
                                <button type="button" onClick={() => setShowNewPassword(!showNewPassword)} className="absolute inset-y-0 right-0 top-6 pr-3 flex items-center text-sm leading-5">
                                    {showNewPassword ?
                                        <svg className="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" /></svg> :
                                        <svg className="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.563 3.029m-2.122-2.122A3 3 0 0012 15a3 3 0 00-1.788-2.712M3 3l18 18"/></svg>
                                    }
                                </button>
                            </div>
                            <div className="relative">
                                <label htmlFor="confirm-password" className="block text-sm font-medium text-gray-700">新しいパスワード（確認）</label>
                                <input id="confirm-password" type={showConfirmPassword ? 'text' : 'password'} value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm pr-10" required />
                                <button type="button" onClick={() => setShowConfirmPassword(!showConfirmPassword)} className="absolute inset-y-0 right-0 top-6 pr-3 flex items-center text-sm leading-5">
                                    {showConfirmPassword ?
                                        <svg className="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" /></svg> :
                                        <svg className="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.563-3.029m-2.122-2.122A3 3 0 0012 15a3 3 0 00-1.788-2.712M3 3l18 18"/></svg>
                                    }
                                </button>
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">パスワードを更新</button>
                        </form>
                    </div>
                </div>
            );
        };
        const MemberManagementModal = ({ show, onClose, item, db, userId, showCustomAlert }) => {
            const getRoleDisplayName = (role) => ({ owner: 'オーナー', editor: '編集者', viewer: '閲覧者' }[role] || '不明');
            
            const handleCopyCode = (code) => {
                if(!code) {
                    showCustomAlert("コードが見つかりません。");
                    return;
                }
                const dummy = document.createElement("textarea");
                document.body.appendChild(dummy);
                dummy.value = code;
                dummy.select();
                document.execCommand("copy");
                document.body.removeChild(dummy);
                showCustomAlert(`コード「${code}」をコピーしました。`);
            };

            const handleRemoveMember = async (memberIdToRemove) => {
                if (memberIdToRemove === userId) {
                    showCustomAlert("自分自身を削除することはできません。");
                    return;
                }
                if (!window.confirm(`メンバー「${item.accessControl[memberIdToRemove].email}」をプロジェクトから削除しますか？`)) return;

                try {
                    const projectRef = window.firebase.doc(db, `artifacts/${window.__app_id}/projects`, item.id);
                    await window.firebase.updateDoc(projectRef, {
                        memberIds: window.firebase.arrayRemove(memberIdToRemove),
                        [`accessControl.${memberIdToRemove}`]: window.firebase.deleteField()
                    });
                    showCustomAlert("メンバーを削除しました。");
                } catch (error) {
                    console.error("メンバーの削除に失敗しました:", error);
                    showCustomAlert("メンバーの削除に失敗しました。");
                }
            };

            const currentUserRole = item.accessControl?.[userId]?.role;

            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full relative">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2 text-center">メンバー管理</h2>
                        <p className="text-center text-gray-600 mb-6">プロジェクト: {item.name}</p>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        <div className="mb-6">
                            <h3 className="text-lg font-semibold text-gray-700 mb-2">現在のメンバー</h3>
                            <ul className="space-y-2">
                                {Object.entries(item.accessControl || {}).map(([uid, memberData]) => (
                                    <li key={uid} className="flex justify-between items-center bg-gray-100 p-2 rounded-md">
                                        <span className="text-sm text-gray-800 truncate">
                                            {memberData.email || uid} {uid === userId && "(あなた)"}
                                        </span>
                                        <div className="flex items-center">
                                            <span className="text-sm font-semibold text-gray-600 bg-gray-200 px-2 py-1 rounded-full">{getRoleDisplayName(memberData.role)}</span>
                                            {currentUserRole === 'owner' && uid !== userId && (
                                                <button onClick={() => handleRemoveMember(uid)} className="ml-3 text-red-500 hover:text-red-700 font-bold">&times;</button>
                                            )}
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                        {currentUserRole === 'owner' && (
                             <div className="mt-6 border-t pt-4">
                                <h3 className="text-lg font-semibold text-gray-700 mb-2">参加コード</h3>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center bg-yellow-50 p-3 rounded-md">
                                        <div>
                                            <p className="font-semibold text-gray-800">閲覧者用コード</p>
                                            <p className="font-mono tracking-widest text-lg text-gray-900">{item.invitationCodes?.viewer || 'N/A'}</p>
                                        </div>
                                        <button onClick={() => handleCopyCode(item.invitationCodes?.viewer)} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg shadow-md text-xs">コピー</button>
                                    </div>
                                    <div className="flex justify-between items-center bg-yellow-50 p-3 rounded-md">
                                        <div>
                                            <p className="font-semibold text-gray-800">編集者用コード</p>
                                            <p className="font-mono tracking-widest text-lg text-gray-900">{item.invitationCodes?.editor || 'N/A'}</p>
                                        </div>
                                        <button onClick={() => handleCopyCode(item.invitationCodes?.editor)} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg shadow-md text-xs">コピー</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        const ProjectManagementPage = ({ userId, userEmail, db, showCustomAlert }) => {
            const [projects, setProjects] = useState([]);
            const [newProjectName, setNewProjectName] = useState('');
            const [isMemberModalOpen, setMemberModalOpen] = useState(false);
            const [selectedProject, setSelectedProject] = useState(null);
            const [isDeleteConfirmOpen, setIsDeleteConfirmOpen] = useState(false);
            const [deletingProject, setDeletingProject] = useState(null);

            const generateCode = () => {
                const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            };

            useEffect(() => {
                if (!db || !userId) return;
                const projectsRef = window.firebase.collection(db, `artifacts/${window.__app_id}/projects`);
                const q = window.firebase.query(projectsRef, window.firebase.where("memberIds", "array-contains", userId));

                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                    const fetchedProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProjects(fetchedProjects);
                }, (error) => {
                    console.error("Error fetching projects: ", error);
                    showCustomAlert("プロジェクトの読み込みに失敗しました。");
                });

                return () => unsubscribe();
            }, [db, userId]);

            const handleAddProject = async () => {
                if (!newProjectName.trim()) {
                    showCustomAlert("プロジェクト名を入力してください。");
                    return;
                }
                try {
                    const projectsRef = window.firebase.collection(db, `artifacts/${window.__app_id}/projects`);
                    await window.firebase.addDoc(projectsRef, {
                        name: newProjectName,
                        ownerId: userId,
                        memberIds: [userId],
                        accessControl: { [userId]: { role: 'owner', email: userEmail } },
                        createdAt: window.firebase.serverTimestamp(),
                        invitationCodes: {
                            viewer: generateCode(),
                            editor: generateCode(),
                        }
                    });
                    setNewProjectName('');
                    showCustomAlert(`プロジェクト「${newProjectName}」を作成しました。`);
                } catch (error) {
                    console.error("Error adding project: ", error);
                    showCustomAlert("プロジェクトの作成に失敗しました。");
                }
            };
            
            const openMemberModal = (project) => {
                setSelectedProject(project);
                setMemberModalOpen(true);
            };

            const openDeleteConfirm = (project) => {
                setDeletingProject(project);
                setIsDeleteConfirmOpen(true);
            };
            const closeDeleteConfirm = () => {
                setDeletingProject(null);
                setIsDeleteConfirmOpen(false);
            };

            const handleDeleteProject = async () => {
                if (!deletingProject) return;

                try {
                    const batch = window.firebase.writeBatch(db);
                    
                    const casesRef = window.firebase.collection(db, `artifacts/${window.__app_id}/cases`);
                    const q = window.firebase.query(casesRef, window.firebase.where("projectId", "==", deletingProject.id));
                    const caseSnapshot = await window.firebase.getDocs(q);
                    
                    caseSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    const projectRef = window.firebase.doc(db, `artifacts/${window.__app_id}/projects`, deletingProject.id);
                    batch.delete(projectRef);

                    await batch.commit();

                    showCustomAlert(`プロジェクト「${deletingProject.name}」とその関連案件を削除しました。`);
                    closeDeleteConfirm();
                } catch (error) {
                    console.error("Error deleting project:", error);
                    showCustomAlert("プロジェクトの削除に失敗しました。");
                    closeDeleteConfirm();
                }
            };

            return (
                <div className="w-full max-w-6xl">
                    <div className="mb-8 p-6 bg-indigo-50 rounded-xl shadow-md">
                        <h2 className="text-2xl font-semibold text-indigo-700 mb-4">新しいプロジェクトを作成</h2>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={newProjectName}
                                onChange={e => setNewProjectName(e.target.value)}
                                placeholder="例: A社共有プロジェクト"
                                className="flex-grow mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
                            />
                            <button onClick={handleAddProject} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">作成</button>
                        </div>
                    </div>
                    <div className="p-6 bg-white rounded-xl shadow-md">
                        <h2 className="text-2xl font-semibold text-gray-700 mb-4">プロジェクト一覧</h2>
                        <div className="space-y-4">
                            {projects.length > 0 ? projects.map(project => {
                                const userRole = project.accessControl?.[userId]?.role;
                                return (
                                <div key={project.id} className="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center">
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-800">{project.name}</h3>
                                        <p className="text-sm text-gray-500">メンバー数: {project.memberIds.length}人</p>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        {userRole === 'owner' && (
                                            <>
                                                <button onClick={() => openMemberModal(project)} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">メンバー管理</button>
                                                <button onClick={() => openDeleteConfirm(project)} className="text-gray-400 hover:text-red-600 font-semibold py-2 px-3 rounded-lg">削除</button>
                                            </>
                                        )}
                                    </div>
                                </div>
                                )
                            }) : (
                                <p className="text-gray-500 text-center">参加しているプロジェクトはありません。</p>
                            )}
                        </div>
                    </div>
                    {isMemberModalOpen && selectedProject && (
                        <MemberManagementModal
                            show={isMemberModalOpen}
                            onClose={() => setMemberModalOpen(false)}
                            item={selectedProject}
                            db={db}
                            userId={userId}
                            showCustomAlert={showCustomAlert}
                        />
                    )}
                    {isDeleteConfirmOpen && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">プロジェクト削除の確認</h3>
                                <p className="text-gray-700 mb-6">本当にプロジェクト「{deletingProject?.name}」を削除しますか？<br/>このプロジェクトに関連する全ての案件も削除されます。この操作は元に戻せません。</p>
                                <div className="flex justify-end space-x-4">
                                    <button onClick={closeDeleteConfirm} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">キャンセル</button>
                                    <button onClick={handleDeleteProject} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">はい、削除します</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const CaseManagementApp = ({ userId, db, showCustomAlert }) => {
            const [cases, setCases] = useState([]);
            const [projects, setProjects] = useState([]); 
            const [projectMap, setProjectMap] = useState({});
            const [selectedProjectId, setSelectedProjectId] = useState(''); 

            const [newCaseName, setNewCaseName] = useState(''); const [newClient, setNewClient] = useState(''); const [newAssignee, setNewAssignee] = useState(''); const [newStatus, setNewStatus] = useState('未着手'); const [newStartDate, setNewStartDate] = useState(''); const [newDueDate, setNewDueDate] = useState(''); const [newBasePrice, setNewBasePrice] = useState(''); const [newPdfUrl, setNewPdfUrl] = useState(''); const [newEvents, setNewEvents] = useState([]); const [newEventDate, setNewEventDate] = useState(''); const [newEventDescription, setNewEventDescription] = useState(''); const [newEvent_Type, setNewEvent_Type] = useState('提出'); const [newEventPdfUrl, setNewEventPdfUrl] = useState('');
            const [allClients, setAllClients] = useState([]); const [allAssignees, setAllAssignees] = useState([]);
            const [filterProject, setFilterProject] = useState('');
            const [filterClient, setFilterClient] = useState(''); const [filterAssignee, setFilterAssignee] = useState(''); const [filterStatus, setFilterStatus] = useState('');
            const [filterStartDate, setFilterStartDate] = useState(''); const [filterEndDate, setFilterEndDate] = useState('');
            const [dateFilterType, setDateFilterType] = useState('createdAt');
            const [showFilters, setShowFilters] = useState(false);
            const [error, setError] = useState(null);
            const [isEditModalOpen, setIsEditModalOpen] = useState(false); const [editingCase, setEditingCase] = useState(null); const [editedCaseName, setEditedCaseName] = useState(''); const [editedClient, setEditedClient] = useState(''); const [editedAssignee, setEditedAssignee] = useState(''); const [editedStatus, setEditedStatus] = useState(''); const [editedStartDate, setEditedStartDate] = useState(''); const [editedDueDate, setEditedDueDate] = useState(''); const [editedBasePrice, setEditedBasePrice] = useState(''); const [editedPdfUrl, setEditedPdfUrl] = useState(''); const [editedEvents, setEditedEvents] = useState([]);
            const [listDisplayMode, setListDisplayMode] = useState('card');
            const [isDeleteConfirmOpen, setIsDeleteConfirmOpen] = useState(false);
            const [deletingCaseId, setDeletingCaseId] = useState(null);
            
            useEffect(() => {
                if (!db || !userId) return;
                
                let unsubscribeCases = () => {};

                const projectsRef = window.firebase.collection(db, `artifacts/${window.__app_id}/projects`);
                const qProjects = window.firebase.query(projectsRef, window.firebase.where("memberIds", "array-contains", userId));
                
                const unsubscribeProjects = window.firebase.onSnapshot(qProjects, (projectSnapshot) => {
                    const userProjects = projectSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProjects(userProjects);
                    const newProjectMap = userProjects.reduce((map, proj) => ({...map, [proj.id]: proj}), {});
                    setProjectMap(newProjectMap);
                    
                    if(!selectedProjectId && userProjects.length > 0){
                        setSelectedProjectId(userProjects[0].id);
                    }

                    const projectIds = userProjects.map(p => p.id);

                    if (projectIds.length > 0) {
                        const casesRef = window.firebase.collection(db, `artifacts/${window.__app_id}/cases`);
                        const qCases = window.firebase.query(casesRef, window.firebase.where("projectId", "in", projectIds));
                        
                        unsubscribeCases(); 
                        unsubscribeCases = window.firebase.onSnapshot(qCases, (caseSnapshot) => {
                            const fetchedCases = caseSnapshot.docs.map(doc => {
                                const project = newProjectMap[doc.data().projectId];
                                return { 
                                    id: doc.id, 
                                    ...doc.data(),
                                    accessControl: project ? project.accessControl : {}
                                };
                            });
                            fetchedCases.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                            setCases(fetchedCases);
                        });
                    } else {
                        setCases([]);
                    }
                }, (err) => {
                    console.error("プロジェクトの取得エラー:", err);
                    setError("プロジェクトの取得に失敗しました。");
                });
                
                const clientsRef = window.firebase.collection(db, `artifacts/${window.__app_id}/users/${userId}/clients`);
                const unsubscribeClients = window.firebase.onSnapshot(clientsRef, (snapshot) => {
                    const fetchedClients = snapshot.docs.map(doc => doc.data().name);
                    setAllClients(fetchedClients);
                });

                return () => {
                    unsubscribeProjects();
                    unsubscribeClients();
                    unsubscribeCases();
                };
            }, [db, userId]);

            const addNewClientTag = async (clientName) => {
                if (!clientName || allClients.includes(clientName)) return;
                try {
                    const clientsRef = window.firebase.collection(db, `artifacts/${window.__app_id}/users/${userId}/clients`);
                    await window.firebase.addDoc(clientsRef, { name: clientName, createdAt: window.firebase.serverTimestamp() });
                } catch (e) { console.error("取引先タグの追加エラー: ", e); }
            };
            
            const handleAddCase = async () => {
                if (!newCaseName.trim() || !selectedProjectId) { 
                    showCustomAlert('案件名とプロジェクトは必須です。'); 
                    return; 
                }

                try {
                    if(newClient.trim()) {
                      await addNewClientTag(newClient);
                    }
                    const casesCollectionRef = window.firebase.collection(db, `artifacts/${window.__app_id}/cases`);
                    const newCaseData = {
                        name: newCaseName, client: newClient, assignee: newAssignee, status: newStatus,
                        startDate: newStartDate, dueDate: newDueDate, basePrice: newBasePrice ? parseFloat(newBasePrice) : 0,
                        pdfUrl: newPdfUrl, events: newEvents, createdAt: window.firebase.serverTimestamp(),
                        projectId: selectedProjectId,
                        owner: userId,
                    };
                    await window.firebase.addDoc(casesCollectionRef, newCaseData);
                    
                    setNewCaseName(''); setNewClient(''); setNewAssignee(''); setNewStatus('未着手'); setNewStartDate(''); setNewDueDate(''); setNewBasePrice(''); setNewPdfUrl(''); setNewEvents([]); setNewEventDate(''); setNewEventDescription(''); setNewEvent_Type('提出'); setNewEventPdfUrl('');
                } catch (e) {
                    console.error("案件の追加に失敗しました:", e);
                    showCustomAlert(`案件の追加に失敗しました。(${e.message})`);
                }
            };

            const handleUpdateCase = async () => {
                if (!editingCase || !editedCaseName.trim()) { 
                    showCustomAlert('案件名は必須です。'); 
                    return; 
                }
                if (editedClient.trim()){
                  await addNewClientTag(editedClient);
                }
                
                const caseDocRef = window.firebase.doc(db, `artifacts/${window.__app_id}/cases`, editingCase.id);
                await window.firebase.updateDoc(caseDocRef, { 
                    name: editedCaseName, 
                    client: editedClient, 
                    assignee: editedAssignee, 
                    status: editedStatus, 
                    startDate: editedStartDate, 
                    dueDate: editedDueDate, 
                    basePrice: editedBasePrice ? parseFloat(editedBasePrice) : 0, 
                    pdfUrl: editedPdfUrl, 
                    events: editedEvents, 
                    updatedAt: window.firebase.serverTimestamp() 
                });
                showCustomAlert('案件が正常に更新されました！');
                closeEditModal();
            };
            
            const openDeleteConfirm = (caseId) => { setDeletingCaseId(caseId); setIsDeleteConfirmOpen(true); };
            const closeDeleteConfirm = () => { setDeletingCaseId(null); setIsDeleteConfirmOpen(false); };

            const handleDeleteCase = async () => {
                if (!deletingCaseId) return;
                try {
                    const caseDocRef = window.firebase.doc(db, `artifacts/${window.__app_id}/cases`, deletingCaseId);
                    await window.firebase.deleteDoc(caseDocRef);
                    showCustomAlert('案件を削除しました。');
                } catch(e) { 
                    console.error("案件削除エラー: ", e); 
                    showCustomAlert("案件の削除に失敗しました。");
                } finally { 
                    closeDeleteConfirm(); 
                    closeEditModal(); 
                }
            };

            const handleAddNewEvent = () => { if (newEventDate && newEventDescription && newEvent_Type) { setNewEvents([...newEvents, { date: newEventDate, description: newEventDescription, type: newEvent_Type, pdfUrl: newEventPdfUrl, completed: false }]); setNewEventDate(''); setNewEventDescription(''); setNewEvent_Type('提出'); setNewEventPdfUrl(''); } else { showCustomAlert('イベントの日付、内容、種類は必須です。'); } };
            const handleRemoveNewEvent = (index) => setNewEvents(newEvents.filter((_, i) => i !== index));
            const handleToggleNewEventCompletion = (index) => { const ev = [...newEvents]; if (ev[index]) { ev[index].completed = !ev[index].completed; setNewEvents(ev); } };
            
            const handleAddEditedEvent = () => { if (newEventDate && newEventDescription && newEvent_Type) { setEditedEvents([...editedEvents, { date: newEventDate, description: newEventDescription, type: newEvent_Type, pdfUrl: newEventPdfUrl, completed: false }]); setNewEventDate(''); setNewEventDescription(''); setNewEvent_Type('提出'); setNewEventPdfUrl(''); } else { showCustomAlert('イベントの日付、内容、種類は必須です。'); } };
            const handleRemoveEditedEvent = (index) => setEditedEvents(editedEvents.filter((_, i) => i !== index));
            const handleToggleEditedEventCompletion = (index) => { const ev = [...editedEvents]; if (ev[index]) { ev[index].completed = !ev[index].completed; setEditedEvents(ev); } };

            const openEditModal = (caseItem) => {
                setEditingCase(caseItem); 
                setEditedCaseName(caseItem.name); 
                setEditedClient(caseItem.client || ''); 
                setEditedAssignee(caseItem.assignee || ''); 
                setEditedStatus(caseItem.status); 
                setEditedStartDate(caseItem.startDate || ''); 
                setEditedDueDate(caseItem.dueDate || ''); 
                setEditedBasePrice(caseItem.basePrice || ''); 
                setEditedPdfUrl(caseItem.pdfUrl || ''); 
                setEditedEvents(caseItem.events || []); 
                setNewEventDate(''); 
                setNewEventDescription(''); 
                setNewEvent_Type('提出'); 
                setNewEventPdfUrl(''); 
                setIsEditModalOpen(true);
            };
            
            const closeEditModal = () => { setIsEditModalOpen(false); setEditingCase(null); };

            const filteredCases = useMemo(() => {
                return cases.filter(caseItem => {
                    const projectMatch = filterProject ? caseItem.projectId === filterProject : true;
                    const clientMatch = filterClient ? caseItem.client === filterClient : true;
                    const assigneeMatch = filterAssignee ? caseItem.assignee === filterAssignee : true;
                    const statusMatch = filterStatus ? caseItem.status === filterStatus : true;
                    
                    const startFilter = filterStartDate ? new Date(filterStartDate) : null;
                    const endFilter = filterEndDate ? new Date(filterEndDate) : null;
                    if(startFilter) startFilter.setHours(0,0,0,0);
                    if(endFilter) endFilter.setHours(23,59,59,999);

                    let dateMatch = true;
                    if (startFilter || endFilter) {
                        let dateToCheck = null;
                        if (dateFilterType === 'createdAt' && caseItem.createdAt) {
                             dateToCheck = caseItem.createdAt.toDate();
                        } else if (dateFilterType === 'startDate' && caseItem.startDate) {
                            dateToCheck = new Date(caseItem.startDate);
                        } else if (dateFilterType === 'dueDate' && caseItem.dueDate) {
                            dateToCheck = new Date(caseItem.dueDate);
                        }
                        
                        if (dateToCheck) {
                             if(startFilter && dateToCheck < startFilter) dateMatch = false;
                             if(endFilter && dateToCheck > endFilter) dateMatch = false;
                        } else {
                            dateMatch = false;
                        }
                    }

                    return projectMatch && clientMatch && assigneeMatch && statusMatch && dateMatch;
                });
            }, [cases, filterProject, filterClient, filterAssignee, filterStatus, filterStartDate, filterEndDate, dateFilterType]);
            
            const renderCurrentView = () => {
                const viewProps = { cases: filteredCases, openEditModal, userId };
                if (filteredCases.length === 0) {
                    return <p className="text-gray-500 text-center py-8">表示できる案件がありません。新しい案件を追加するか、フィルター条件を変更してください。</p>;
                }
                
                if (listDisplayMode === 'card') {
                    return (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {filteredCases.map((caseItem) => {
                                const userRole = caseItem.accessControl?.[userId]?.role;
                                const canEdit = userRole === 'owner' || userRole === 'editor';
                                return (
                                    <div key={caseItem.id} className="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-2">{caseItem.name}</h3>
                                        <p className="text-gray-600 text-sm">取引先: {caseItem.client || '-'}</p>
                                        <p className="text-gray-600 text-sm">担当者: {caseItem.assignee || '-'}</p>
                                        <p className="text-gray-600 text-sm">ステータス: <span className={`font-medium ${ caseItem.status === '完了' ? 'text-green-600' : caseItem.status === '進行中' ? 'text-blue-600' : caseItem.status === '確認待ち' ? 'text-yellow-600' : caseItem.status === 'キャンセル' ? 'text-red-600' : 'text-gray-600' }`}>{caseItem.status}</span></p>
                                        {caseItem.startDate && <p className="text-gray-600 text-xs">開始日: {caseItem.startDate}</p>}
                                        {caseItem.dueDate && <p className="text-gray-600 text-xs">完了予定日: {caseItem.dueDate}</p>}
                                        {userRole === 'owner' && caseItem.basePrice > 0 && <p className="text-gray-600 text-xs">基本料金: {caseItem.basePrice.toLocaleString()}円</p>}
                                        {caseItem.pdfUrl && <p className="text-gray-600 text-xs">添付URL: <a href={caseItem.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline break-all">表示</a></p>}
                                        {caseItem.events && caseItem.events.length > 0 && <div className="mt-2 text-xs text-gray-600"><strong>イベント:</strong><ul className="list-disc list-inside">{caseItem.events.map((event, idx) => (<li key={idx} className={`${event.completed ? 'line-through text-gray-500' : ''}`}>[{event.type}] {event.date}: {event.description}{event.pdfUrl && <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-xs ml-2">添付URL</a>}</li>))}</ul></div>}
                                        <div className="flex-grow"></div>
                                        {caseItem.createdAt && <p className="text-gray-500 text-xs mt-auto pt-2">作成日: {new Date(caseItem.createdAt.toDate()).toLocaleString()}</p>}
                                        {canEdit && <button onClick={() => openEditModal(caseItem)} className="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">編集</button>}
                                    </div>
                                );
                            })}
                        </div>
                    );
                }
                if (listDisplayMode === 'table') {
                    return (
                        <div className="w-full overflow-x-auto">
                            <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead>
                                    <tr className="bg-gray-100 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                                        <th className="py-3 px-4 border-b">案件名</th>
                                        <th className="py-3 px-4 border-b">取引先</th>
                                        <th className="py-3 px-4 border-b">担当者</th>
                                        <th className="py-3 px-4 border-b">ステータス</th>
                                        <th className="py-3 px-4 border-b">基本料金</th>
                                        <th className="py-3 px-4 border-b">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredCases.map((caseItem) => {
                                        const userRole = caseItem.accessControl?.[userId]?.role;
                                        const canEdit = userRole === 'owner' || userRole === 'editor';
                                        return (
                                            <tr key={caseItem.id} className="border-b border-gray-200 hover:bg-gray-50">
                                                <td className="py-3 px-4 text-sm text-gray-800 font-semibold">{caseItem.name}</td>
                                                <td className="py-3 px-4 text-sm text-gray-600">{caseItem.client || '-'}</td>
                                                <td className="py-3 px-4 text-sm text-gray-600">{caseItem.assignee || '-'}</td>
                                                <td className="py-3 px-4 text-sm text-gray-600"><span className={`font-medium ${ caseItem.status === '完了' ? 'text-green-600' : caseItem.status === '進行中' ? 'text-blue-600' : caseItem.status === '確認待ち' ? 'text-yellow-600' : caseItem.status === 'キャンセル' ? 'text-red-600' : 'text-gray-600' }`}>{caseItem.status}</span></td>
                                                <td className="py-3 px-4 text-sm text-gray-600">{userRole === 'owner' && caseItem.basePrice ? `${caseItem.basePrice.toLocaleString()}円` : '-'}</td>
                                                <td className="py-3 px-4">
                                                    {canEdit && <button onClick={() => openEditModal(caseItem)} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg shadow-md text-xs">編集</button>}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    );
                }
                if (listDisplayMode === 'timeline') {
                    const casesWithDates = filteredCases.filter(c => c.status !== '完了' && c.startDate && c.dueDate);
                    if (casesWithDates.length === 0) return <p className="text-gray-500 text-center py-8">タイムラインに表示できる案件がありません。</p>;
                    return (
                        <div className="space-y-4">
                            {casesWithDates.map(caseItem => {
                                const userRole = caseItem.accessControl?.[userId]?.role;
                                const canEdit = userRole === 'owner' || userRole === 'editor';
                                return (
                                    <div key={caseItem.id} className="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 relative">
                                        <div className="font-semibold text-gray-800 mb-2">{caseItem.name}</div>
                                        <div className="overflow-visible"><TimelineBar startDate={caseItem.startDate} dueDate={caseItem.dueDate} status={caseItem.status} events={caseItem.events} /></div>
                                        <div className="mt-4 text-right">
                                            {canEdit && <button onClick={() => openEditModal(caseItem)} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg text-xs">編集</button>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    );
                }
                if (listDisplayMode === 'calendar') {
                    return <ListCalendarView {...viewProps} />;
                }
                return null;
            };

            return (
              <div className="w-full max-w-6xl">
                  <div className="mb-8 p-6 bg-indigo-50 rounded-xl shadow-md">
                    <h2 className="text-2xl font-semibold text-indigo-700 mb-4">新しい案件を追加</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div className="md:col-span-2">
                        <label htmlFor="project" className="block text-sm font-medium text-gray-700 mb-1">プロジェクト<span className="text-red-500">*</span></label>
                        <select id="project" value={selectedProjectId} onChange={(e) => setSelectedProjectId(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="" disabled>プロジェクトを選択してください</option>
                            {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                      </div>
                      <div><label htmlFor="newCaseName" className="block text-sm font-medium text-gray-700 mb-1">案件名<span className="text-red-500">*</span></label><input type="text" id="newCaseName" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newCaseName} onChange={(e) => setNewCaseName(e.target.value)} placeholder="例: 株式会社ABC ロゴデザイン" /></div>
                      <div><label htmlFor="newClient" className="block text-sm font-medium text-gray-700 mb-1">取引先</label><input type="text" id="newClient" list="client-list" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newClient} onChange={(e) => setNewClient(e.target.value)} placeholder="例: 株式会社XYZ" /><datalist id="client-list">{allClients.map(c => <option key={c} value={c} />)}</datalist></div>
                      <div><label htmlFor="newStatus" className="block text-sm font-medium text-gray-700 mb-1">ステータス</label><select id="newStatus" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newStatus} onChange={(e) => setNewStatus(e.target.value)}><option value="未着手">未着手</option><option value="進行中">進行中</option><option value="確認待ち">確認待ち</option><option value="完了">完了</option><option value="キャンセル">キャンセル</option></select></div>
                      <div><label htmlFor="newAssignee" className="block text-sm font-medium text-gray-700 mb-1">担当者</label><input type="text" id="newAssignee" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newAssignee} onChange={(e) => setNewAssignee(e.target.value)} placeholder="例: 山田太郎" /></div>
                      <div className="grid grid-cols-2 gap-4 md:col-span-2">
                        <div><label htmlFor="newBasePrice" className="block text-sm font-medium text-gray-700 mb-1">基本料金 (円)</label><input type="number" id="newBasePrice" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newBasePrice} onChange={(e) => setNewBasePrice(e.target.value)} placeholder="例: 50000" /></div>
                        <div><label htmlFor="newPdfUrl" className="block text-sm font-medium text-gray-700 mb-1">添付URL</label><input type="url" id="newPdfUrl" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newPdfUrl} onChange={(e) => setNewPdfUrl(e.target.value)} placeholder="例: https://example.com/document.pdf" /></div>
                      </div>
                      <div><label htmlFor="newStartDate" className="block text-sm font-medium text-gray-700 mb-1">開始日</label><input type="date" id="newStartDate" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newStartDate} onChange={(e) => setNewStartDate(e.target.value)} /></div>
                      <div><label htmlFor="newDueDate" className="block text-sm font-medium text-gray-700 mb-1">完了予定日</label><input type="date" id="newDueDate" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newDueDate} onChange={(e) => setNewDueDate(e.target.value)} /></div>
                    </div>
                    <div className="mb-4 p-4 bg-indigo-100 rounded-md">
                      <h3 className="text-lg font-semibold text-indigo-800 mb-2">タイムラインイベントを追加</h3>
                      <div className="flex flex-wrap gap-2 mb-2">
                        <input type="date" className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEventDate} onChange={(e) => setNewEventDate(e.target.value)} />
                        <input type="text" className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEventDescription} onChange={(e) => setNewEventDescription(e.target.value)} placeholder="例: 校正提出済み" />
                        <input type="url" className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEventPdfUrl} onChange={(e) => setNewEventPdfUrl(e.target.value)} placeholder="添付URL" />
                        <select className="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEvent_Type} onChange={(e) => setNewEvent_Type(e.target.value)}><option value="提出">提出</option><option value="タスク">タスク</option></select>
                        <button onClick={handleAddNewEvent} className="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">追加</button>
                      </div>
                      <div className="mt-3">{newEvents.length > 0 ? (<ul className="list-disc list-inside text-sm text-gray-700">{newEvents.map((event, index) => (<li key={index} className={`flex justify-between items-center py-1 ${event.completed ? 'line-through text-gray-500' : ''}`}><span>[{event.type}] {event.date}: {event.description}{event.pdfUrl && <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-xs ml-2">添付URL</a>}</span><div><button onClick={() => handleToggleNewEventCompletion(index)} className={`ml-2 px-2 py-1 rounded-md text-xs font-semibold ${event.completed ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-700'}`}> {event.completed ? '完了済み' : '完了'}</button><button onClick={() => handleRemoveNewEvent(index)} className="text-red-500 hover:text-red-700 ml-2">&times;</button></div></li>))}</ul>) : (<p className="text-sm text-gray-500">イベントはまだありません。</p>)}</div>
                    </div>
                    
                    <button onClick={handleAddCase} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">案件を追加</button>
                  </div>

                  <div className="p-6 bg-white rounded-xl shadow-md">
                     <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-4">
                      <h2 className="text-2xl font-semibold text-gray-700 shrink-0">案件一覧</h2>
                      <div className="flex flex-wrap justify-center gap-2">
                        {['card', 'table', 'timeline', 'calendar'].map((mode) => ( <button key={mode} onClick={() => setListDisplayMode(mode)} className={`py-2 px-4 rounded-lg font-semibold transition text-sm ${listDisplayMode === mode ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700'}`}>{ {card: 'カード', table: 'テーブル', timeline: 'タイムライン', calendar: 'カレンダー'}[mode] }表示</button>))}
                      </div>
                      <button onClick={() => setShowFilters(!showFilters)} className="p-2 rounded-md hover:bg-gray-200">
                          <svg className="w-6 h-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>
                      </button>
                    </div>
                    {showFilters && (
                        <div className="p-4 bg-gray-50 rounded-lg">
                             <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                               <select value={filterProject} onChange={e => setFilterProject(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="">すべてのプロジェクト</option>{projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select>
                               <select value={filterClient} onChange={e => setFilterClient(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="">すべての取引先</option>{allClients.map(c => <option key={c} value={c}>{c}</option>)}</select>
                               <select value={filterAssignee} onChange={e => setFilterAssignee(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="">すべての担当者</option>{allAssignees.map(a => <option key={a} value={a}>{a}</option>)}</select>
                               <select value={filterStatus} onChange={e => setFilterStatus(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="">すべてのステータス</option><option value="未着手">未着手</option><option value="進行中">進行中</option><option value="確認待ち">確認待ち</option><option value="完了">完了</option><option value="キャンセル">キャンセル</option></select>
                               <div className="lg:col-span-2">
                                    <div className="flex items-center gap-2">
                                        <select value={dateFilterType} onChange={e => setDateFilterType(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white">
                                            <option value="createdAt">登録日</option>
                                            <option value="startDate">開始日</option>
                                            <option value="dueDate">完了日</option>
                                        </select>
                                        <div className="flex-grow flex items-center gap-2">
                                             <input type="date" value={filterStartDate} onChange={e => setFilterStartDate(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" />
                                             <span>~</span>
                                             <input type="date" value={filterEndDate} onChange={e => setFilterEndDate(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" />
                                        </div>
                                    </div>
                               </div>
                            </div>
                        </div>
                    )}
                     <div className="mt-4 flex flex-wrap gap-2">
                        {filterProject && <span className="inline-flex items-center px-2 py-1 bg-gray-200 text-sm font-medium text-gray-800 rounded-full">プロジェクト: {projectMap[filterProject]?.name} <button onClick={() => setFilterProject('')} className="ml-1 font-bold text-red-500">&times;</button></span>}
                        {filterClient && <span className="inline-flex items-center px-2 py-1 bg-gray-200 text-sm font-medium text-gray-800 rounded-full">取引先: {filterClient} <button onClick={() => setFilterClient('')} className="ml-1 font-bold text-red-500">&times;</button></span>}
                        {filterAssignee && <span className="inline-flex items-center px-2 py-1 bg-gray-200 text-sm font-medium text-gray-800 rounded-full">担当者: {filterAssignee} <button onClick={() => setFilterAssignee('')} className="ml-1 font-bold text-red-500">&times;</button></span>}
                        {filterStatus && <span className="inline-flex items-center px-2 py-1 bg-gray-200 text-sm font-medium text-gray-800 rounded-full">ステータス: {filterStatus} <button onClick={() => setFilterStatus('')} className="ml-1 font-bold text-red-500">&times;</button></span>}
                        {(filterStartDate || filterEndDate) && <span className="inline-flex items-center px-2 py-1 bg-gray-200 text-sm font-medium text-gray-800 rounded-full">{ {startDate: '開始日', dueDate: '完了日', createdAt: '登録日'}[dateFilterType] }: {filterStartDate || '*'} ~ {filterEndDate || '*'} <button onClick={() => { setFilterStartDate(''); setFilterEndDate(''); }} className="ml-1 font-bold text-red-500">&times;</button></span>}
                    </div>
                    <div className="mt-4">{renderCurrentView()}</div>
                  </div>

                  {isEditModalOpen && editingCase && (
                     <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                        <div className="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full relative max-h-[90vh] overflow-y-auto">
                           <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">案件を編集</h2>
                           <button onClick={closeEditModal} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                            <div className="space-y-4">
                                <div><label htmlFor="editedCaseName" className="block text-sm font-medium text-gray-700">案件名<span className="text-red-500">*</span></label><input type="text" id="editedCaseName" value={editedCaseName} onChange={(e) => setEditedCaseName(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" /></div>
                                <div><label htmlFor="editedClient" className="block text-sm font-medium text-gray-700">取引先</label><input type="text" id="editedClient" list="client-list" value={editedClient} onChange={(e) => setEditedClient(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" /><datalist id="client-list">{allClients.map(c => <option key={c} value={c} />)}</datalist></div>
                                <div><label htmlFor="editedStatus" className="block text-sm font-medium text-gray-700">ステータス</label><select id="editedStatus" value={editedStatus} onChange={(e) => setEditedStatus(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="未着手">未着手</option><option value="進行中">進行中</option><option value="確認待ち">確認待ち</option><option value="完了">完了</option><option value="キャンセル">キャンセル</option></select></div>
                                <div><label htmlFor="editedAssignee" className="block text-sm font-medium text-gray-700">担当者</label><input type="text" id="editedAssignee" value={editedAssignee} onChange={(e) => setEditedAssignee(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" /></div>
                                <div><label htmlFor="editedBasePrice" className="block text-sm font-medium text-gray-700">基本料金 (円)</label><input type="number" id="editedBasePrice" value={editedBasePrice} onChange={(e) => setEditedBasePrice(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" /></div>
                                <div><label htmlFor="editedPdfUrl" className="block text-sm font-medium text-gray-700">添付URL</label><input type="url" id="editedPdfUrl" value={editedPdfUrl} onChange={(e) => setEditedPdfUrl(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" /></div>
                                <div><label htmlFor="editedStartDate" className="block text-sm font-medium text-gray-700">開始日</label><input type="date" id="editedStartDate" value={editedStartDate} onChange={(e) => setEditedStartDate(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" /></div>
                                <div><label htmlFor="editedDueDate" className="block text-sm font-medium text-gray-700">完了予定日</label><input type="date" id="editedDueDate" value={editedDueDate} onChange={(e) => setEditedDueDate(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" /></div>
                            </div>
                            <div className="mt-6 border-t pt-6">
                                <h3 className="text-lg font-semibold text-gray-700 mb-2">タイムラインイベントを追加</h3>
                                <div className="flex flex-wrap gap-2 mb-2">
                                    <input type="date" className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEventDate} onChange={(e) => setNewEventDate(e.target.value)} />
                                    <input type="text" className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEventDescription} onChange={(e) => setNewEventDescription(e.target.value)} placeholder="例: 校正提出済み" />
                                    <input type="url" className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEventPdfUrl} onChange={(e) => setNewEventPdfUrl(e.target.value)} placeholder="添付URL" />
                                    <select className="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEvent_Type} onChange={(e) => setNewEvent_Type(e.target.value)}><option value="提出">提出</option><option value="タスク">タスク</option></select>
                                    <button onClick={handleAddEditedEvent} className="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">追加</button>
                                </div>
                                <div className="mt-3">{editedEvents.length > 0 ? (<ul className="list-disc list-inside text-sm text-gray-700">{editedEvents.map((event, index) => (<li key={index} className={`flex justify-between items-center py-1 ${event.completed ? 'line-through text-gray-500' : ''}`}><span>[{event.type}] {event.date}: {event.description}{event.pdfUrl && <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-xs ml-2">添付URL</a>}</span><div><button onClick={() => handleToggleEditedEventCompletion(index)} className={`ml-2 px-2 py-1 rounded-md text-xs font-semibold ${event.completed ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-700'}`}> {event.completed ? '完了済み' : '完了'}</button><button onClick={() => handleRemoveEditedEvent(index)} className="text-red-500 hover:text-red-700 ml-2">&times;</button></div></li>))}</ul>) : (<p className="text-sm text-gray-500">イベントはまだありません。</p>)}</div>
                            </div>
                           <div className="mt-6 border-t pt-6">
                                <button onClick={handleUpdateCase} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">案件を更新</button>
                                <button onClick={() => openDeleteConfirm(editingCase.id)} className="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">案件を削除</button>
                            </div>
                        </div>
                     </div>
                  )}
                  {isDeleteConfirmOpen && (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                        <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">削除の確認</h3>
                            <p className="text-gray-700 mb-6">本当にこの案件を削除しますか？<br/>この操作は元に戻せません。</p>
                            <div className="flex justify-end space-x-4">
                                <button onClick={closeDeleteConfirm} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">キャンセル</button>
                                <button onClick={handleDeleteCase} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">はい、削除します</button>
                            </div>
                        </div>
                    </div>
                  )}
              </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);
            const [currentView, setCurrentView] = useState('cases');
            
            const [showAlert, setShowAlert] = useState(false);
            const [alertMessage, setAlertMessage] = useState('');
            const [isSettingsModalOpen, setSettingsModalOpen] = useState(false);
            const [isAccountMenuOpen, setAccountMenuOpen] = useState(false);
            const [isJoinProjectModalOpen, setJoinProjectModalOpen] = useState(false);
            const accountMenuRef = useRef(null);
            
            const showCustomAlert = (message) => { setAlertMessage(message); setShowAlert(true); };

            useEffect(() => {
                let unsubscribe;
                try {
                    const firebaseConfig = window.__firebase_config;
                    const mainApp = window.firebase.getApps().length ? window.firebase.getApp("mainApp") : window.firebase.initializeApp(firebaseConfig, "mainApp");
                    const firebaseAuth = window.firebase.getAuth(mainApp);
                    const firestoreDb = window.firebase.getFirestore(mainApp);
                    setAuth(firebaseAuth);
                    setDb(firestoreDb);
                    
                    unsubscribe = window.firebase.onAuthStateChanged(firebaseAuth, (user) => {
                        setUser(user);
                        setLoading(false);
                    });
                } catch (err) {
                    console.error("Firebase Initialization Error:", err);
                    setAuthError("Firebaseの初期化に失敗しました。");
                    setLoading(false);
                }
                return () => { if(unsubscribe) unsubscribe(); };
            }, []);

            const handleLogout = async () => {
                try {
                    await window.firebase.signOut(auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                    showCustomAlert("ログアウト中にエラーが発生しました。");
                }
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-100"><p className="text-lg font-semibold text-gray-600">読み込み中...</p></div>;
            if (authError && !auth) return <div className="min-h-screen flex items-center justify-center bg-red-100 text-red-700 p-4"><p>{authError}</p></div>;

            if (!user) {
                return <LoginPage auth={auth} setAuthError={setAuthError} authError={authError} />;
            }

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col items-center py-10 px-4 sm:px-6 lg:px-8 font-sans">
                    <div className="w-full max-w-6xl">
                         <div className="flex justify-between items-start mb-6">
                            <div>
                                <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">Anken</h1>
                                <div className="mt-4 border-b border-gray-200">
                                    <nav className="-mb-px flex space-x-8" aria-label="Tabs">
                                        <button onClick={() => setCurrentView('cases')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${currentView === 'cases' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                                            案件管理
                                        </button>
                                        <button onClick={() => setCurrentView('projects')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${currentView === 'projects' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                                            プロジェクト管理
                                        </button>
                                    </nav>
                                </div>
                            </div>
                            <div className="relative z-20 flex items-center">
                                <button onClick={() => setJoinProjectModalOpen(true)} className="mr-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm">プロジェクトに参加</button>
                                <div ref={accountMenuRef}>
                                    <button onClick={() => setAccountMenuOpen(!isAccountMenuOpen)} className="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition">
                                        <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    </button>
                                    {isAccountMenuOpen && (
                                        <div className="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-1 z-50">
                                            <div className="px-4 py-2 text-sm text-gray-700 border-b">{user.email}</div>
                                            <button onClick={() => { setSettingsModalOpen(true); setAccountMenuOpen(false); }} className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">設定</button>
                                            <button onClick={handleLogout} className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ログアウト</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {currentView === 'cases' ? (
                            <CaseManagementApp userId={user.uid} db={db} showCustomAlert={showCustomAlert} />
                        ) : (
                            <ProjectManagementPage userId={user.uid} userEmail={user.email} db={db} showCustomAlert={showCustomAlert} />
                        )}
                    </div>

                    {showAlert && ( <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50"><div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative"><h3 className="text-lg font-bold text-gray-800 mb-4">お知らせ</h3><p className="text-gray-700 mb-6">{alertMessage}</p><button onClick={() => setShowAlert(false)} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">閉じる</button></div></div> )}
                    {isSettingsModalOpen && <SettingsModal user={auth.currentUser} auth={auth} closeModal={() => setSettingsModalOpen(false)} showCustomAlert={showCustomAlert} />}
                    {isJoinProjectModalOpen && <JoinProjectModal show={isJoinProjectModalOpen} onClose={() => setJoinProjectModalOpen(false)} db={db} user={user} showCustomAlert={showCustomAlert} />}

                </div>
            );
        }

        function JoinProjectModal({ show, onClose, db, user, showCustomAlert }) {
            const [code, setCode] = useState('');

            if (!show) return null;

            const handleJoin = async () => {
                if (!code.trim()) {
                    showCustomAlert("参加コードを入力してください。");
                    return;
                }
                const uppercaseCode = code.trim().toUpperCase();

                try {
                    const projectsRef = window.firebase.collection(db, `artifacts/${window.__app_id}/projects`);
                    const viewerQuery = window.firebase.query(projectsRef, window.firebase.where("invitationCodes.viewer", "==", uppercaseCode));
                    const editorQuery = window.firebase.query(projectsRef, window.firebase.where("invitationCodes.editor", "==", uppercaseCode));
                    
                    const [viewerSnapshot, editorSnapshot] = await Promise.all([
                        window.firebase.getDocs(viewerQuery),
                        window.firebase.getDocs(editorQuery)
                    ]);
                    
                    let projectDoc;
                    let role;

                    if (!viewerSnapshot.empty) {
                        projectDoc = viewerSnapshot.docs[0];
                        role = 'viewer';
                    } else if (!editorSnapshot.empty) {
                        projectDoc = editorSnapshot.docs[0];
                        role = 'editor';
                    } else {
                        throw new Error("無効な参加コードです。");
                    }

                    const projectRef = projectDoc.ref;
                    const projectData = projectDoc.data();

                    if (projectData.memberIds.includes(user.uid)) {
                        throw new Error("あなたはこのプロジェクトに既に参加しています。");
                    }
                    
                    await window.firebase.updateDoc(projectRef, {
                        memberIds: window.firebase.arrayUnion(user.uid),
                        [`accessControl.${user.uid}`]: { role: role, email: user.email }
                    });
                    
                    showCustomAlert(`プロジェクト「${projectData.name}」に参加しました！`);
                    onClose();

                } catch (error) {
                    console.error("プロジェクトへの参加に失敗しました:", error);
                    showCustomAlert(error.message || "プロジェクトへの参加に失敗しました。");
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full relative">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">プロジェクトに参加</h2>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        <div className="space-y-4">
                            <div>
                                <label htmlFor="join-code" className="block text-sm font-medium text-gray-700">参加コード</label>
                                <input 
                                  id="join-code" 
                                  type="text" 
                                  value={code} 
                                  onChange={(e) => setCode(e.target.value)} 
                                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm uppercase" 
                                  placeholder="ABCDEF"
                                />
                            </div>
                            <button onClick={handleJoin} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">参加する</button>
                        </div>
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
