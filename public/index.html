<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>デザイン案件管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>

    <script>
        window.__firebase_config = {
            apiKey: "AIzaSyD9qsQN6YvNbrtikGFARTs20-ABRSNSh9A",
            authDomain: "anken-0614.firebaseapp.com",
            projectId: "anken-0614",
            storageBucket: "anken-0614.appspot.com",
            messagingSenderId: "258080558206",
            appId: "1:258080558206:web:a9176c09cae666036b1c2f",
            measurementId: "G-633CQ2WNJX"
        };
        
        window.__app_id = typeof __app_id !== 'undefined' ? __app_id : window.__firebase_config.appId;
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        window.firebase = {
            initializeApp, getApps, getApp, getAuth, onAuthStateChanged,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
            setPersistence, browserLocalPersistence,
            getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp,
            doc, updateDoc, arrayUnion, getAnalytics
        };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>


    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // --- Child Components ---
        const TimelineBar = ({ startDate, dueDate, status, events = [] }) => {
          if (!startDate || !dueDate) return <div className="text-gray-500 text-xs">日付未設定</div>;
          const start = new Date(startDate);
          const end = new Date(dueDate);
          const today = new Date();
          start.setHours(0, 0, 0, 0);
          end.setHours(0, 0, 0, 0);
          today.setHours(0, 0, 0, 0);
          const totalDurationMs = end.getTime() - start.getTime();
          const [activeTooltipIndex, setActiveTooltipIndex] = useState(null);
          const [showStartTooltip, setShowStartTooltip] = useState(false);
          const [showEndTooltip, setShowEndTooltip] = useState(false);
          const getEventTypeColor = (event) => { if (event.completed) return 'bg-green-500'; switch (event.type) { case '予定': case '提出': return 'bg-yellow-500'; case 'タスク': return 'bg-red-500'; case '完了': return 'bg-green-500'; default: return 'bg-purple-600'; } };
          const eventMarkers = events.map((event) => { const eventDate = new Date(event.date); eventDate.setHours(0, 0, 0, 0); const eventOffsetMs = eventDate.getTime() - start.getTime(); let position = totalDurationMs > 0 ? (eventOffsetMs / totalDurationMs) * 100 : 0; return { ...event, position: Math.max(0, Math.min(100, position)) }; }).sort((a, b) => a.position - b.position);
          let progressPercentage = 0;
          if (totalDurationMs > 0) { const elapsedMs = today.getTime() - start.getTime(); progressPercentage = Math.max(0, Math.min(100, (elapsedMs / totalDurationMs) * 100)); }
          const barColorClass = 'bg-gray-700';
          const progressColorClass = status === '完了' ? 'bg-blue-500' : 'bg-green-500';
          const todayMarkerPosition = totalDurationMs > 0 ? Math.max(0, Math.min(100, (today.getTime() - start.getTime()) / totalDurationMs * 100)) : -1;
          return (
            <div className="relative w-full h-8 rounded-lg my-1">
              <div className={`absolute top-1/2 -translate-y-1/2 left-0 h-0.5 ${barColorClass} w-full rounded-lg`}></div>
              {status !== '完了' && <div className={`absolute top-1/2 -translate-y-1/2 left-0 h-0.5 ${progressColorClass} transition-all duration-500 ease-out rounded-lg`} style={{ width: `${progressPercentage}%` }}></div>}
              {todayMarkerPosition >= 0 && <div className="absolute bottom-full mb-1 h-0 w-0 border-l-[6px] border-r-[6px] border-t-[8px] border-l-transparent border-r-transparent border-t-black z-10" style={{ left: `${todayMarkerPosition}%`, transform: 'translateX(-50%)' }} title="今日"></div>}
              <div className="absolute top-1/2 -translate-y-1/2 w-3 h-3 z-30 cursor-pointer" style={{ left: `0%`, transform: 'translateX(-50%)' }} onMouseEnter={() => setShowStartTooltip(true)} onMouseLeave={() => setShowStartTooltip(false)}>
                <div className="absolute left-1/2 -translate-x-1/2 w-0.5 h-4 bg-gray-800 -top-2"></div><div className="absolute left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-gray-800 -top-4"></div>
                {showStartTooltip && (<div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap"><p>開始日: {startDate}</p><div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div></div>)}
              </div>
              <div className="absolute top-1/2 -translate-y-1/2 w-3 h-3 z-30 cursor-pointer" style={{ left: `100%`, transform: 'translateX(-50%)' }} onMouseEnter={() => setShowEndTooltip(true)} onMouseLeave={() => setShowEndTooltip(false)}>
                <div className="absolute left-1/2 -translate-x-1/2 w-0.5 h-4 bg-gray-800 -top-2"></div><div className="absolute left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-gray-800 -top-4"></div>
                {showEndTooltip && (<div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap"><p>完了予定日: {dueDate}</p><div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div></div>)}
              </div>
              {eventMarkers.map((event, index) => (
                <div key={index} className={`absolute w-3 h-3 z-20 cursor-pointer ${getEventTypeColor(event)} ${event.type === 'タスク' ? '' : 'rounded-full'}`} style={{ left: `${event.position}%`, top: '50%', transform: 'translate(-50%, -50%)' }} onMouseEnter={() => setActiveTooltipIndex(index)} onMouseLeave={() => setActiveTooltipIndex(null)} onClick={() => setActiveTooltipIndex(activeTooltipIndex === index ? null : index)}>
                  {activeTooltipIndex === index && (<div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-40"><p>{event.date}</p><p>{event.description}</p>{event.pdfUrl && (<p className="text-xs text-gray-400"><a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-300 hover:underline">PDFを表示</a></p>)}<div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-4 border-t-gray-800"></div></div>)}
                </div>
              ))}
            </div>
          );
        };
        const VerticalCaseTimeline = ({ caseItem, displayStartDate, heightPerDay, openEditModal, onCaseHover }) => {
          const caseStartDate = new Date(caseItem.startDate); const caseDueDate = new Date(caseItem.dueDate);
          const effectiveStartDate = new Date(Math.max(caseStartDate.getTime(), displayStartDate.getTime()));
          const effectiveDueDate = new Date(caseDueDate.getTime());
          const startOffsetDays = (effectiveStartDate.getTime() - displayStartDate.getTime()) / (1000 * 60 * 60 * 24);
          const topPx = Math.max(0, startOffsetDays * heightPerDay);
          const durationDays = (effectiveDueDate.getTime() - effectiveStartDate.getTime()) / (1000 * 60 * 60 * 24);
          const heightPx = Math.max(2, durationDays * heightPerDay);
          if (topPx < 0 && (topPx + heightPx < 0)) return null;
          const sortedEvents = [...(caseItem.events || [])].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
          const getEventTypeShapeClass = (event) => (event.type === 'タスク' ? '' : 'rounded-full');
          const getEventColorClass = (event) => { if (event.completed) return 'bg-green-500'; switch (event.type) { case '予定': case '提出': return 'bg-yellow-500'; case 'タスク': return 'bg-red-500'; case '完了': return 'bg-green-500'; default: return 'bg-purple-600'; } };
          const [activeTooltipIndex, setActiveTooltipIndex] = useState(null);
          return (
            <div className="absolute w-0.5 bg-gray-800 flex flex-col items-center cursor-pointer" style={{ top: `${topPx}px`, height: `${heightPx}px` }} onClick={() => openEditModal(caseItem)} onMouseEnter={() => onCaseHover(caseItem)} onMouseLeave={() => onCaseHover(null)}>
              <div className="absolute w-3 h-3 bg-black rounded-full z-20" style={{ top: '0px', transform: 'translateY(-50%) translateX(-50%)', left: '50%' }}></div>
              <div className="absolute w-3 h-3 bg-black rounded-full z-20" style={{ bottom: '0px', transform: 'translateY(50%) translateX(-50%)', left: '50%' }}></div>
              {sortedEvents.map((event, eventIdx) => {
                const eventDate = new Date(event.date);
                const eventOffsetDays = (eventDate.getTime() - effectiveStartDate.getTime()) / (1000 * 60 * 60 * 24);
                const eventTopPx = eventOffsetDays * heightPerDay;
                if (eventTopPx < 0 || eventTopPx > heightPx) return null;
                return (
                  <div key={eventIdx} className={`absolute w-3 h-3 z-20 cursor-pointer ${getEventColorClass(event)} ${getEventTypeShapeClass(event)}`} style={{ top: `${eventTopPx}px`, left: '50%', transform: 'translateX(-50%)' }} onMouseEnter={() => setActiveTooltipIndex(eventIdx)} onMouseLeave={() => setActiveTooltipIndex(null)}>
                    {activeTooltipIndex === eventIdx && (<div className="absolute left-1/2 -translate-x-1/2 mt-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-30" style={{ top: '100%' }}><p>{event.date}</p><p>{event.description}</p>{event.pdfUrl && (<p className="text-xs text-gray-400"><a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-300 hover:underline">PDF</a></p>)}<div className="absolute bottom-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div></div>)}
                  </div>);
              })}
            </div>
          );
        };
        const ListCalendarView = ({ cases, openEditModal }) => {
          const scrollContainerRef = useRef(null);
          const heightPerDay = 20;
          const [loadedDaysBefore, setLoadedDaysBefore] = useState(15);
          const [loadedDaysAfter, setLoadedDaysAfter] = useState(15);
          const loadIncrement = 30;
          const [hoveredCaseInfo, setHoveredCaseInfo] = useState(null);
          const today = useMemo(() => { const d = new Date(); d.setHours(0, 0, 0, 0); return d; }, []);
          const displayStartDate = useMemo(() => { const d = new Date(today); d.setDate(today.getDate() - loadedDaysBefore); return d; }, [today, loadedDaysBefore]);
          const displayEndDate = useMemo(() => { const d = new Date(today); d.setDate(today.getDate() + loadedDaysAfter); return d; }, [today, loadedDaysAfter]);
          const datesToDisplay = useMemo(() => { const dates = []; let loopDate = new Date(displayStartDate); while (loopDate <= displayEndDate) { dates.push(new Date(loopDate)); loopDate.setDate(loopDate.getDate() + 1); } return dates; }, [displayStartDate, displayEndDate]);
          const totalContentHeight = datesToDisplay.length * heightPerDay;
          const firstViewHeight = 31 * heightPerDay;
          useEffect(() => { if (scrollContainerRef.current) { const todayIndex = datesToDisplay.findIndex(date => date.getTime() === today.getTime()); if (todayIndex !== -1) { const scrollToY = (todayIndex * heightPerDay) - (scrollContainerRef.current.clientHeight / 2) + (heightPerDay / 2); scrollContainerRef.current.scrollTop = Math.max(0, scrollToY); } } }, [datesToDisplay, today, heightPerDay]);
          const handleScroll = useCallback(() => { if (!scrollContainerRef.current) return; const { scrollTop, scrollHeight, clientHeight } = scrollContainerRef.current; const scrollThreshold = 50; if (scrollTop < scrollThreshold) { const oldScrollHeight = scrollHeight; setLoadedDaysBefore(prev => prev + loadIncrement); requestAnimationFrame(() => { if (scrollContainerRef.current) { scrollContainerRef.current.scrollTop = scrollContainerRef.current.scrollHeight - oldScrollHeight; } }); } if (scrollTop + clientHeight > scrollHeight - scrollThreshold) { setLoadedDaysAfter(prev => prev + loadIncrement); } }, [loadIncrement]);
          useEffect(() => { const currentRef = scrollContainerRef.current; if (currentRef) { currentRef.addEventListener('scroll', handleScroll); return () => currentRef.removeEventListener('scroll', handleScroll); } }, [handleScroll]);
          const visibleCases = cases.filter(c => c.startDate && c.dueDate && new Date(c.dueDate) >= displayStartDate && new Date(c.startDate) <= displayEndDate && c.status !== '完了');
          const dateColumnWidth = 96; const caseColumnWidth = 100; const minContentWidth = dateColumnWidth + (visibleCases.length * caseColumnWidth) + 50;
          const formatDateToYYMMDD = (date) => { const year = date.getFullYear().toString().slice(-2); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); return `${year}.${month}/${day}`; };
          const handleCaseHover = (caseItem) => setHoveredCaseInfo(caseItem);
          return (
            <div className="p-6 bg-white rounded-xl shadow-md">
              <h2 className="text-2xl font-semibold text-gray-700 mb-4 text-center">カレンダー表示 (縦型タイムライン)</h2>
              <div ref={scrollContainerRef} className="relative flex-grow overflow-y-scroll overflow-x-auto border border-gray-200 rounded-lg" style={{ maxHeight: `${firstViewHeight}px` }}>
                <div className="relative" style={{ minHeight: `${totalContentHeight}px`, minWidth: `${minContentWidth}px` }}>
                  {datesToDisplay.map((date, index) => { const isToday = date.getTime() === today.getTime(); return (<div key={date.toISOString()} className={`absolute w-full flex items-center border-b border-gray-200 ${isToday ? 'bg-red-50' : ''}`} style={{ top: `${index * heightPerDay}px`, height: `${heightPerDay}px` }}><div className={`w-24 text-sm text-center flex-shrink-0 ${isToday ? 'font-bold text-blue-700' : 'text-gray-600'}`}>{formatDateToYYMMDD(date)}</div></div>); })}
                  {visibleCases.map((caseItem, index) => (<div key={caseItem.id} className="absolute" style={{ left: `${dateColumnWidth + (index * caseColumnWidth) + 20}px`, width: `${caseColumnWidth}px`, height: '100%' }}><VerticalCaseTimeline caseItem={caseItem} displayStartDate={displayStartDate} heightPerDay={heightPerDay} openEditModal={openEditModal} onCaseHover={handleCaseHover} /></div>))}
                </div>
              </div>
              <div className="mt-4 p-3 bg-gray-100 rounded-lg border border-gray-200 w-full text-left">
                {hoveredCaseInfo ? (<div className="text-gray-800 text-sm"><p className="font-semibold">案件名: {hoveredCaseInfo.name}</p><p>開始日: {hoveredCaseInfo.startDate || '-'}</p><p>完了予定日: {hoveredCaseInfo.dueDate || '-'}</p><p>ステータス: {hoveredCaseInfo.status}</p></div>) : ( <p className="text-gray-500 text-sm">案件ラインにマウスを合わせると詳細が表示されます。</p> )}
              </div>
            </div>
          );
        };
        function LoginPage({ auth, setAuthError, authError }) {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [isLogin, setIsLogin] = useState(true);
            const handleAuthAction = async (e) => {
                e.preventDefault(); setAuthError(null);
                try {
                    if (isLogin) { await window.firebase.signInWithEmailAndPassword(auth, email, password); }
                    else { await window.firebase.createUserWithEmailAndPassword(auth, email, password); }
                } catch (error) { console.error(`${isLogin ? 'ログイン' : '登録'}中にエラー:`, error); setAuthError(error.message); }
            };
            return (
                <div className="min-h-screen bg-gray-100 flex flex-col justify-center items-center py-12 sm:px-6 lg:px-8">
                    <div className="sm:mx-auto sm:w-full sm:max-w-md"><h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">{isLogin ? '案件管理へようこそ' : 'アカウントを作成'}</h2></div>
                    <div className="mt-8 sm:mx-auto sm:w-full sm:max-w-md"><div className="bg-white py-8 px-4 shadow-xl rounded-lg sm:px-10">
                        <form className="space-y-6" onSubmit={handleAuthAction}>
                            <div><label htmlFor="email" className="block text-sm font-medium text-gray-700">メールアドレス</label><div className="mt-1"><input id="email" name="email" type="email" autoComplete="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" /></div></div>
                            <div><label htmlFor="password" className="block text-sm font-medium text-gray-700">パスワード</label><div className="mt-1"><input id="password" name="password" type="password" autoComplete="current-password" required value={password} onChange={(e) => setPassword(e.target.value)} className="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" /></div></div>
                            {authError && <p className="text-red-500 text-xs mt-2">{authError}</p>}
                            <div><button type="submit" className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">{isLogin ? 'ログイン' : '登録'}</button></div>
                        </form>
                        <div className="mt-6"><div className="relative"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-300"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">{isLogin ? 'アカウントをお持ちでないですか？' : 'すでにアカウントをお持ちですか？'}</span></div></div>
                        <div className="mt-6"><button onClick={() => { setIsLogin(!isLogin); setAuthError(null); }} className="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">{isLogin ? '新しくアカウントを作成' : 'ログイン画面へ'}</button></div></div>
                    </div></div>
                </div>
            );
        }
        function CaseManagementApp({ userId, userEmail, auth, db }) {
            const [cases, setCases] = useState([]);
            const [newCaseName, setNewCaseName] = useState(''); const [newAssignee, setNewAssignee] = useState(''); const [newStatus, setNewStatus] = useState('未着手'); const [newStartDate, setNewStartDate] = useState(''); const [newDueDate, setNewDueDate] = useState(''); const [newBasePrice, setNewBasePrice] = useState(''); const [newPdfUrl, setNewPdfUrl] = useState(''); const [newEvents, setNewEvents] = useState([]); const [newEventDate, setNewEventDate] = useState(''); const [newEventDescription, setNewEventDescription] = useState(''); const [newEvent_Type, setNewEvent_Type] = useState('提出'); const [newEventPdfUrl, setNewEventPdfUrl] = useState('');
            const [error, setError] = useState(null);
            const [isEditModalOpen, setIsEditModalOpen] = useState(false); const [editingCase, setEditingCase] = useState(null); const [editedCaseName, setEditedCaseName] = useState(''); const [editedAssignee, setEditedAssignee] = useState(''); const [editedStatus, setEditedStatus] = useState(''); const [editedStartDate, setEditedStartDate] = useState(''); const [editedDueDate, setEditedDueDate] = useState(''); const [editedBasePrice, setEditedBasePrice] = useState(''); const [editedPdfUrl, setEditedPdfUrl] = useState(''); const [editedEvents, setEditedEvents] = useState([]);
            const [listDisplayMode, setListDisplayMode] = useState('timeline');
            const [showAlert, setShowAlert] = useState(false); const [alertMessage, setAlertMessage] = useState('');
            const showCustomAlert = (message) => { setAlertMessage(message); setShowAlert(true); };
            const handleLogout = async () => { try { await window.firebase.signOut(auth); } catch (error) { console.error("ログアウトエラー:", error); showCustomAlert("ログアウト中にエラーが発生しました。"); } };
            useEffect(() => {
                if (!db || !userId) return;
                const casesCollectionRef = window.firebase.collection(db, `artifacts/${window.__app_id}/users/${userId}/cases`);
                const q = window.firebase.query(casesCollectionRef);
                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => { const fetchedCases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); fetchedCases.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)); setCases(fetchedCases); }, (err) => { console.error("案件データの取得エラー:", err); setError("案件データの取得に失敗しました。"); });
                return () => unsubscribe();
            }, [db, userId]);
            const handleAddCase = async () => {
                if (!newCaseName.trim() || !newAssignee.trim()) { showCustomAlert('案件名と担当者は必須です。'); return; }
                const casesCollectionRef = window.firebase.collection(db, `artifacts/${window.__app_id}/users/${userId}/cases`);
                await window.firebase.addDoc(casesCollectionRef, { name: newCaseName, assignee: newAssignee, status: newStatus, startDate: newStartDate, dueDate: newDueDate, basePrice: newBasePrice ? parseFloat(newBasePrice) : 0, pdfUrl: newPdfUrl, events: newEvents, createdAt: window.firebase.serverTimestamp(), owner: userId });
                setNewCaseName(''); setNewAssignee(''); setNewStatus('未着手'); setNewStartDate(''); setNewDueDate(''); setNewBasePrice(''); setNewPdfUrl(''); setNewEvents([]); setNewEventDate(''); setNewEventDescription(''); setNewEvent_Type('提出'); setNewEventPdfUrl('');
            };
            const handleUpdateCase = async () => {
                if (!editingCase || !editedCaseName.trim() || !editedAssignee.trim()) { showCustomAlert('案件名と担当者は必須です。'); return; }
                const caseDocRef = window.firebase.doc(db, `artifacts/${window.__app_id}/users/${userId}/cases`, editingCase.id);
                await window.firebase.updateDoc(caseDocRef, { name: editedCaseName, assignee: editedAssignee, status: editedStatus, startDate: editedStartDate, dueDate: editedDueDate, basePrice: editedBasePrice ? parseFloat(editedBasePrice) : 0, pdfUrl: editedPdfUrl, events: editedEvents, updatedAt: window.firebase.serverTimestamp() });
                showCustomAlert('案件が正常に更新されました！'); closeEditModal();
            };
            const handleAddNewEvent = () => { if (newEventDate && newEventDescription && newEvent_Type) { setNewEvents([...newEvents, { date: newEventDate, description: newEventDescription, type: newEvent_Type, pdfUrl: newEventPdfUrl, completed: false }]); setNewEventDate(''); setNewEventDescription(''); setNewEvent_Type('提出'); setNewEventPdfUrl(''); } else { showCustomAlert('イベントの日付、内容、種類は必須です。'); } };
            const handleRemoveNewEvent = (index) => setNewEvents(newEvents.filter((_, i) => i !== index));
            const handleToggleNewEventCompletion = (index) => { const ev = [...newEvents]; if (ev[index]) { ev[index].completed = !ev[index].completed; setNewEvents(ev); } };
            const openEditModal = (caseItem) => { setEditingCase(caseItem); setEditedCaseName(caseItem.name); setEditedAssignee(caseItem.assignee); setEditedStatus(caseItem.status); setEditedStartDate(caseItem.startDate || ''); setEditedDueDate(caseItem.dueDate || ''); setEditedBasePrice(caseItem.basePrice || ''); setEditedPdfUrl(caseItem.pdfUrl || ''); setEditedEvents(caseItem.events || []); setNewEventDate(''); setNewEventDescription(''); setNewEvent_Type('提出'); setNewEventPdfUrl(''); setIsEditModalOpen(true); };
            const closeEditModal = () => { setIsEditModalOpen(false); setEditingCase(null); };
            const handleAddEditedEvent = () => { if (newEventDate && newEventDescription && newEvent_Type) { setEditedEvents([...editedEvents, { date: newEventDate, description: newEventDescription, type: newEvent_Type, pdfUrl: newEventPdfUrl, completed: false }]); setNewEventDate(''); setNewEventDescription(''); setNewEvent_Type('提出'); setNewEventPdfUrl(''); } else { showCustomAlert('イベントの日付、内容、種類は必須です。'); } };
            const handleRemoveEditedEvent = (index) => setEditedEvents(editedEvents.filter((_, i) => i !== index));
            const handleToggleEditedEventCompletion = (index) => { const ev = [...editedEvents]; if (ev[index]) { ev[index].completed = !ev[index].completed; setEditedEvents(ev); } };
            const renderCurrentView = () => {
                const viewProps = { cases, openEditModal };
                switch (listDisplayMode) {
                    case 'card': return (<div className="p-6 bg-white rounded-xl shadow-md"><h2 className="text-2xl font-semibold text-gray-700 mb-4">案件一覧 (カード表示)</h2>{cases.length === 0 ? (<p className="text-gray-500 text-center">案件がありません。</p>) : (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{cases.map((caseItem) => (<div key={caseItem.id} className="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col"><h3 className="text-lg font-semibold text-gray-800 mb-2">{caseItem.name}</h3><p className="text-gray-600 text-sm">担当者: {caseItem.assignee}</p><p className="text-gray-600 text-sm">ステータス: <span className={`font-medium ${ caseItem.status === '完了' ? 'text-green-600' : caseItem.status === '進行中' ? 'text-blue-600' : caseItem.status === '確認待ち' ? 'text-yellow-600' : caseItem.status === 'キャンセル' ? 'text-red-600' : 'text-gray-600' }`}>{caseItem.status}</span></p>{caseItem.startDate && <p className="text-gray-600 text-xs">開始日: {caseItem.startDate}</p>}{caseItem.dueDate && <p className="text-gray-600 text-xs">完了予定日: {caseItem.dueDate}</p>}{caseItem.basePrice > 0 && <p className="text-gray-600 text-xs">基本料金: {caseItem.basePrice.toLocaleString()}円</p>}{caseItem.pdfUrl && <p className="text-gray-600 text-xs">PDF: <a href={caseItem.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline break-all">表示</a></p>}{caseItem.events && caseItem.events.length > 0 && <div className="mt-2 text-xs text-gray-600"><strong>イベント:</strong><ul className="list-disc list-inside">{caseItem.events.map((event, idx) => (<li key={idx} className={`${event.completed ? 'line-through text-gray-500' : ''}`}>[{event.type}] {event.date}: {event.description}{event.pdfUrl && <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-xs ml-2">PDF</a>}</li>))}</ul></div>}{caseItem.createdAt && <p className="text-gray-500 text-xs mt-auto pt-2">作成日: {new Date(caseItem.createdAt.toDate()).toLocaleString()}</p>}<button onClick={() => openEditModal(caseItem)} className="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">編集</button></div>))}</div>)}</div>);
                    case 'table': return (<div className="p-6 bg-white rounded-xl shadow-md"><h2 className="text-2xl font-semibold text-gray-700 mb-4">案件一覧 (テーブル表示)</h2>{cases.length === 0 ? (<p className="text-gray-500 text-center">案件がありません。</p>) : (<div className="w-full overflow-x-auto"><table className="min-w-full bg-white border border-gray-200 rounded-lg"><thead><tr className="bg-gray-100 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider"><th className="py-3 px-4 border-b">案件名</th><th className="py-3 px-4 border-b">担当者</th><th className="py-3 px-4 border-b">ステータス</th><th className="py-3 px-4 border-b">基本料金</th><th className="py-3 px-4 border-b">タスク</th><th className="py-3 px-4 border-b">操作</th></tr></thead><tbody>{cases.map((caseItem) => (<tr key={caseItem.id} className="border-b border-gray-200 hover:bg-gray-50"><td className="py-3 px-4 text-sm text-gray-800 font-semibold">{caseItem.name}</td><td className="py-3 px-4 text-sm text-gray-600">{caseItem.assignee}</td><td className="py-3 px-4 text-sm text-gray-600"><span className={`font-medium ${ caseItem.status === '完了' ? 'text-green-600' : caseItem.status === '進行中' ? 'text-blue-600' : caseItem.status === '確認待ち' ? 'text-yellow-600' : caseItem.status === 'キャンセル' ? 'text-red-600' : 'text-gray-600' }`}>{caseItem.status}</span></td><td className="py-3 px-4 text-sm text-gray-600">{caseItem.basePrice ? `${caseItem.basePrice.toLocaleString()}円` : '-'}</td><td className="py-3 px-4 text-sm text-gray-600">{caseItem.events ? caseItem.events.length : 0}</td><td className="py-3 px-4"><button onClick={() => openEditModal(caseItem)} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg shadow-md text-xs">編集</button></td></tr>))}</tbody></table></div>)}</div>);
                    case 'timeline': return (<div className="p-6 bg-white rounded-xl shadow-md"><h2 className="text-2xl font-semibold text-gray-700 mb-4">案件一覧 (タイムライン表示)</h2><div className="space-y-4">{cases.filter(c => c.status !== '完了' && c.startDate && c.dueDate).map(caseItem => (<div key={caseItem.id} className="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 relative"><div className="font-semibold text-gray-800 mb-2">{caseItem.name}</div><div className="overflow-visible"><TimelineBar startDate={caseItem.startDate} dueDate={caseItem.dueDate} status={caseItem.status} events={caseItem.events} /></div><div className="mt-4 text-right"><button onClick={() => openEditModal(caseItem)} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg text-xs">編集</button></div></div>))}</div></div>);
                    case 'calendar': return <ListCalendarView {...viewProps} />;
                    default: return null;
                }
            };
            return (
              <div className="min-h-screen bg-gray-100 flex flex-col items-center py-10 px-4 sm:px-6 lg:px-8 font-sans">
                <div className="w-full max-w-6xl">
                  {/* ▼▼▼ 修正点: ヘッダーのレイアウトを調整 ▼▼▼ */}
                  <div className="flex justify-between items-center mb-6">
                    <h1 className="text-3xl font-bold text-gray-800">デザイン案件管理</h1>
                    <div className="flex items-center">
                      <span className="text-sm text-gray-600 mr-5">{userEmail}</span>
                      <button onClick={handleLogout} className="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">ログアウト</button>
                    </div>
                  </div>
                  {/* ▲▲▲ 修正点 ▲▲▲ */}
                  <div className="mb-8 p-6 bg-blue-50 rounded-xl shadow-md">
                    <h2 className="text-2xl font-semibold text-blue-700 mb-4">新しい案件を追加</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div><label htmlFor="newCaseName" className="block text-sm font-medium text-gray-700 mb-1">案件名</label><input type="text" id="newCaseName" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newCaseName} onChange={(e) => setNewCaseName(e.target.value)} placeholder="例: 株式会社ABC ロゴデザイン" /></div>
                      <div><label htmlFor="newAssignee" className="block text-sm font-medium text-gray-700 mb-1">担当者</label><input type="text" id="newAssignee" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newAssignee} onChange={(e) => setNewAssignee(e.target.value)} placeholder="例: 山田太郎" /></div>
                      <div><label htmlFor="newStartDate" className="block text-sm font-medium text-gray-700 mb-1">開始日</label><input type="date" id="newStartDate" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newStartDate} onChange={(e) => setNewStartDate(e.target.value)} /></div>
                      <div><label htmlFor="newDueDate" className="block text-sm font-medium text-gray-700 mb-1">完了予定日</label><input type="date" id="newDueDate" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newDueDate} onChange={(e) => setNewDueDate(e.target.value)} /></div>
                      <div><label htmlFor="newStatus" className="block text-sm font-medium text-gray-700 mb-1">ステータス</label><select id="newStatus" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newStatus} onChange={(e) => setNewStatus(e.target.value)}><option value="未着手">未着手</option><option value="進行中">進行中</option><option value="確認待ち">確認待ち</option><option value="完了">完了</option><option value="キャンセル">キャンセル</option></select></div>
                      <div><label htmlFor="newBasePrice" className="block text-sm font-medium text-gray-700 mb-1">基本料金 (円)</label><input type="number" id="newBasePrice" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newBasePrice} onChange={(e) => setNewBasePrice(e.target.value)} placeholder="例: 50000" /></div>
                      <div className="md:col-span-2"><label htmlFor="newPdfUrl" className="block text-sm font-medium text-gray-700 mb-1">PDF URL (添付用)</label><input type="url" id="newPdfUrl" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newPdfUrl} onChange={(e) => setNewPdfUrl(e.target.value)} placeholder="例: https://example.com/document.pdf" /></div>
                    </div>
                    <div className="mb-4 p-4 bg-blue-100 rounded-md">
                      <h3 className="text-lg font-semibold text-blue-800 mb-2">タイムラインイベントを追加</h3>
                      <div className="flex flex-col sm:flex-row gap-2 mb-2">
                        <input type="date" className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEventDate} onChange={(e) => setNewEventDate(e.target.value)} />
                        <input type="text" className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEventDescription} onChange={(e) => setNewEventDescription(e.target.value)} placeholder="例: 校正提出済み" />
                        <input type="url" className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEventPdfUrl} onChange={(e) => setNewEventPdfUrl(e.target.value)} placeholder="イベント関連PDF URL (任意)" />
                        <select className="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={newEvent_Type} onChange={(e) => setNewEvent_Type(e.target.value)}><option value="提出">提出</option><option value="タスク">タスク</option></select>
                        <button onClick={handleAddNewEvent} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">追加</button>
                      </div>
                      <div className="mt-3">{newEvents.length > 0 ? (<ul className="list-disc list-inside text-sm text-gray-700">{newEvents.map((event, index) => (<li key={index} className={`flex justify-between items-center py-1 ${event.completed ? 'line-through text-gray-500' : ''}`}><span>[{event.type}] {event.date}: {event.description}{event.pdfUrl && <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-xs ml-2">PDF</a>}</span><div><button onClick={() => handleToggleNewEventCompletion(index)} className={`ml-2 px-2 py-1 rounded-md text-xs font-semibold ${event.completed ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-700'}`}> {event.completed ? '完了済み' : '完了'}</button><button onClick={() => handleRemoveNewEvent(index)} className="text-red-500 hover:text-red-700 ml-2">&times;</button></div></li>))}</ul>) : (<p className="text-sm text-gray-500">イベントはまだありません。</p>)}</div>
                    </div>
                    <button onClick={handleAddCase} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">案件を追加</button>
                  </div>
                  <div className="mb-6 flex justify-center space-x-4">
                    {['card', 'table', 'timeline', 'calendar'].map((mode) => ( <button key={mode} onClick={() => setListDisplayMode(mode)} className={`py-2 px-6 rounded-lg font-semibold transition ${listDisplayMode === mode ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700'}`}>{ {card: 'カード', table: 'テーブル', timeline: 'タイムライン', calendar: 'カレンダー'}[mode] }表示</button>))}
                  </div>
                  {renderCurrentView()}
                  {isEditModalOpen && editingCase && ( <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50"><div className="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full relative max-h-[90vh] overflow-y-auto"><h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">案件を編集</h2><button onClick={closeEditModal} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">&times;</button><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label htmlFor="editedCaseName" className="block text-sm font-medium text-gray-700 mb-1">案件名</label><input type="text" id="editedCaseName" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={editedCaseName} onChange={(e) => setEditedCaseName(e.target.value)} /></div><div><label htmlFor="editedAssignee" className="block text-sm font-medium text-gray-700 mb-1">担当者</label><input type="text" id="editedAssignee" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={editedAssignee} onChange={(e) => setEditedAssignee(e.target.value)} /></div><div><label htmlFor="editedStartDate" className="block text-sm font-medium text-gray-700 mb-1">開始日</label><input type="date" id="editedStartDate" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={editedStartDate} onChange={(e) => setEditedStartDate(e.target.value)} /></div><div><label htmlFor="editedDueDate" className="block text-sm font-medium text-gray-700 mb-1">完了予定日</label><input type="date" id="editedDueDate" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={editedDueDate} onChange={(e) => setEditedDueDate(e.target.value)} /></div><div><label htmlFor="editedStatus" className="block text-sm font-medium text-gray-700 mb-1">ステータス</label><select id="editedStatus" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={editedStatus} onChange={(e) => setEditedStatus(e.target.value)}><option value="未着手">未着手</option><option value="進行中">進行中</option><option value="確認待ち">確認待ち</option><option value="完了">完了</option><option value="キャンセル">キャンセル</option></select></div><div><label htmlFor="editedBasePrice" className="block text-sm font-medium text-gray-700 mb-1">基本料金 (円)</label><input type="number" id="editedBasePrice" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={editedBasePrice} onChange={(e) => setEditedBasePrice(e.target.value)} /></div><div className="md:col-span-2"><label htmlFor="editedPdfUrl" className="block text-sm font-medium text-gray-700 mb-1">PDF URL (添付用)</label><input type="url" id="editedPdfUrl" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value={editedPdfUrl} onChange={(e) => setEditedPdfUrl(e.target.value)} /></div></div><div className="mb-4 p-4 bg-blue-100 rounded-md"><h3 className="text-lg font-semibold text-blue-800 mb-2">タイムラインイベント</h3><div className="flex flex-wrap items-end gap-2 mb-2"><div className="flex-1 min-w-[120px]"><input type="date" className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm" value={newEventDate} onChange={(e) => setNewEventDate(e.target.value)} /></div><div className="flex-1 min-w-[150px]"><input type="text" className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm" value={newEventDescription} onChange={(e) => setNewEventDescription(e.target.value)} placeholder="例: 校正提出済み" /></div><div className="flex-1 min-w-[150px]"><input type="url" className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm" value={newEventPdfUrl} onChange={(e) => setNewEventPdfUrl(e.target.value)} placeholder="イベント関連PDF URL (任意)" /></div><div className="flex-shrink-0 w-full sm:w-auto"><select className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm" value={newEvent_Type} onChange={(e) => setNewEvent_Type(e.target.value)}><option value="提出">提出</option><option value="タスク">タスク</option></select></div><button onClick={handleAddEditedEvent} className="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">追加</button></div><div className="mt-3 max-h-48 overflow-y-auto pr-2">{editedEvents.length > 0 ? (<ul className="list-disc list-inside text-sm text-gray-700">{editedEvents.map((event, index) => (<li key={index} className={`flex justify-between items-center py-1 ${event.completed ? 'line-through text-gray-500' : ''}`}><span>[{event.type}] {event.date}: {event.description}{event.pdfUrl && <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-xs ml-2">PDF</a>}</span><div><button onClick={() => handleToggleEditedEventCompletion(index)} className={`ml-2 px-2 py-1 rounded-md text-xs font-semibold ${event.completed ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-700'}`}>{event.completed ? '完了済み' : '完了'}</button><button onClick={() => handleRemoveEditedEvent(index)} className="text-red-500 hover:text-red-700 ml-2">&times;</button></div></li>))}</ul>) : (<p className="text-sm text-gray-500">イベントはまだありません。</p>)}</div></div><button onClick={handleUpdateCase} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">案件を更新</button></div></div> )}
                  {showAlert && ( <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50"><div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative"><h3 className="text-lg font-bold text-gray-800 mb-4">お知らせ</h3><p className="text-gray-700 mb-6">{alertMessage}</p><button onClick={() => setShowAlert(false)} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">閉じる</button></div></div> )}
                </div>
              </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                try {
                    let firebaseConfig = window.__firebase_config;
                    let mainApp = window.firebase.getApps().length ? window.firebase.getApp("mainApp") : window.firebase.initializeApp(firebaseConfig, "mainApp");
                    const firebaseAuth = window.firebase.getAuth(mainApp);
                    
                    window.firebase.setPersistence(firebaseAuth, window.firebase.browserLocalPersistence)
                      .then(() => {
                        const unsubscribe = window.firebase.onAuthStateChanged(firebaseAuth, (user) => {
                            setUser(user);
                            setLoading(false);
                        });
                        return unsubscribe;
                      })
                      .catch((error) => {
                        console.error("Error setting auth persistence:", error);
                        setAuthError("認証状態の保存に失敗しました。");
                        setLoading(false);
                      });

                    setDb(window.firebase.getFirestore(mainApp));
                    setAuth(firebaseAuth);

                } catch (err) {
                    console.error("Firebase 初期化エラー:", err);
                    setAuthError("Firebaseの初期化に失敗しました。設定を確認してください。");
                    setLoading(false);
                }
            }, []);

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-100"><p className="text-lg font-semibold text-gray-600">読み込み中...</p></div>;
            if (authError && !auth) return <div className="min-h-screen flex items-center justify-center bg-red-100 text-red-700 p-4"><p>{authError}</p></div>;

            return (
                <div>
                    {user ? (
                        <CaseManagementApp userId={user.uid} userEmail={user.email} auth={auth} db={db} />
                    ) : (
                        <LoginPage auth={auth} setAuthError={setAuthError} authError={authError} />
                    )}
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
